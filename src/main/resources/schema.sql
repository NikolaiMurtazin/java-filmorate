DROP TABLE IF EXISTS FRIENDSHIPS;
DROP TABLE IF EXISTS FILM_LIKES;
DROP TABLE IF EXISTS FILM_GENRES;
DROP TABLE IF EXISTS FILMS;
DROP TABLE IF EXISTS USERS;
DROP TABLE IF EXISTS GENRES;
DROP TABLE IF EXISTS MPAS;

CREATE TABLE IF NOT EXISTS USERS
(
    USER_ID  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    LOGIN    VARCHAR NOT NULL UNIQUE,
    NAME     VARCHAR NOT NULL,
    EMAIL    VARCHAR NOT NULL UNIQUE,
    BIRTHDAY DATE NOT NULL
);

CREATE TABLE IF NOT EXISTS FRIENDSHIPS
(
    USER_ID   BIGINT NOT NULL REFERENCES USERS (USER_ID) ON DELETE CASCADE,
    FRIEND_ID BIGINT NOT NULL REFERENCES USERS (USER_ID) ON DELETE CASCADE,
    IS_MUTUAL BOOLEAN NOT NULL,
    PRIMARY KEY (USER_ID, FRIEND_ID)
);

CREATE TABLE IF NOT EXISTS MPAS
(
    MPA_ID INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME   VARCHAR NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS FILMS
(
    FILM_ID     BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME        VARCHAR NOT NULL,
    DESCRIPTION VARCHAR(200),
    RELEASE_DATE DATE,
    DURATION    INT CHECK (DURATION > 0),
    MPA_ID      INT REFERENCES MPAS (MPA_ID)
);

CREATE TABLE IF NOT EXISTS GENRES
(
    GENRE_ID INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME     VARCHAR NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS FILM_GENRES
(
    FILM_ID  BIGINT  NOT NULL REFERENCES FILMS (FILM_ID) ON DELETE CASCADE,
    GENRE_ID INT NOT NULL REFERENCES GENRES (GENRE_ID) ON DELETE CASCADE,
    PRIMARY KEY (FILM_ID, GENRE_ID)
);

CREATE TABLE IF NOT EXISTS FILM_LIKES
(
    FILM_ID BIGINT  NOT NULL REFERENCES FILMS (FILM_ID) ON DELETE CASCADE,
    USER_ID BIGINT  NOT NULL REFERENCES USERS (USER_ID) ON DELETE CASCADE,
    PRIMARY KEY (FILM_ID, USER_ID)
);